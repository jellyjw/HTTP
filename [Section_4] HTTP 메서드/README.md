## HTTP API 설계

API 설계에서 가장 중요한 것은 **리소스 식별** 이다.

리소스란 **자원** 그 자체로, 만약 `회원 정보` 관리 API를 만들어야 한다면 **회원** 이 리소스가 되는 것이다!

- 회원이라는 리소스만 식별하면 되므로, 회원 리소스를 URI에 매핑
- 회원 등록, 수정, 조회, 삭제 등은 모두 배제한다.

### API URI 설계

리소스 식별, URI 계층 구조를 활용하여 설계해야 한다.

중요한 것은, **URI는 리소스만 식별하는 것이고 리소스와 행위 자체는 분리되어야 한다는 것!**

- 회원 목록 조회 - /members
- 회원 조회, 등록, 수정, 삭제 - /members/${id}

**\*계층 구조상 상위를 컬렉션으로 보고 복수단어 사용을 권장한다. (member → members)**

그렇다면, `회원` 리소스 자체는 `members` 로 식별했지만 **행위** 는 어떻게 구분할까? 바로 HTTP 메서드로 구분하면 된다.

---

## HTTP 메서드

주요 메서드는 다음과 같다.

- `GET` : 리소스 조회
- `POST` : 요청 데이터 처리, 주로 등록에 사용
- `PUT` : 리소스를 대체, 해당 리소스가 없으면 생성(파일을 폴더에 넣는것과 비슷)
- `PATCH` : 리소스 부분 변경
- `DELETE` : 리소스 삭제

기타 메서드는 이런 것들이 있다고만 알아두면 좋다.

- `HEAD` : GET과 동일하지만 메시지 부분을 제외하고, 상태줄과 헤더만 반환
- `OPTIONS` : 대상 리소스에 대한 통신 기능 옵션(메서드)을 설명(주로 CORS 사용)
- `CONNECT` : 대상 리소스로 식별되는 서버에 대한 터널을 설정
- `TRACE` : 대상 리소스에 대한 경로를 따라 메시지 루프백 테스트를 수행

---

### GET

리소스를 조회할때 사용하는 메서드로, 서버에 전달하고 싶은 데이터는 `query` (쿼리 파라미터, 쿼리 스트링) 를 통해서 전달할 수 있다.

→ body를 통해서 전달할수도 있지만, 지원하지 않는 곳이 많아 권장하지 않는다.

---

### POST

요청한 데이터를 처리하기 위한 메서드로, `message body` 를 통해 서버로 요청 데이터를 전달한다.

바디를 통해 들어온 데이터를 처리하는 **모든 기능을 수행** 한다. 만능 메서드 역할을 한다!

- 주로 신규 리소스 등록이나 프로세스 처리에 사용
- 성공시 주로 `201 created` 메세지를 응답으로 보내고, 보통 `Location` 으로 어느 `path` 에 신규 생성되었는지를 포함해서 응답을 보내줌

POST는 만능 메서드라고 했는데, 신규 포스트를 등록하거나, 식별하지 않은 새 리소스를 생성, 기존 자원에 데이터를 추가하는 등 모든 작업의 수행이 가능하다.

**즉, 리소스 URI에 POST 요청이 오면 어떻게 처리할지 리소스마다 따로 정해야 한다.**

### 만능 `Method` POST 정리

- 단순히 데이터를 생성하거나, 변경하는 것을 넘어서 프로세스를 처리해야 하는 경우에도 사용
  - 주문에서 결제 완료, 배달 시작, 배달 완료처럼 값 변경을 넘어 프로세스의 상태를 변경하는 경우에도 사용된다.
  - POST의 결과로 새 리소스가 생성되지 않을 수도 있다.
- 컨트롤 URI 의 경우에도 `POST` 가 쓰인다. (POST /orders/{orderId}/start-delivery)
  - 실무에서 리소스 URI만 가지고 설계하기 어려운 부분이 있는데, 기본적으로 리소스를 기반으로 URI를 설계하되 어려운 경우에만 컨트롤 URI로 설계해야 한다.
- 다른 메서드로 처리하기 애매한 경우
  - JSON으로 조회 데이터를 넘겨야 하는데 `GET` 으로 `body` 를 넘길수는 있지만 지원하지 않는 서버가 많기때문에 이럴때도 사용
- **`POST` 는 캐싱이 어려우므로 조회할때는 최대한 `GET` 을 사용하는게 좋다.**

---

### PUT

리소스를 **대체** 하는 메서드로, 리소스가 있을시 대체하고 없을시 생성한다. 파일을 폴더 안에 넣을때 없으면 넣어지고 있으면 덮어씌워지는데 이와 같은 개념으로 생각하면 된다.

### PUT과 POST의 차이

POST는 `/members` 에 요청을 보낼 경우 유저 아이디나 어떤 특정 값을 기준으로 리소스가 생성되지만, PUT은 **클라이언트가 리소스를 식별** 하기 때문에 리소스의 위치를 알고 URI를 직접 지정한다는 차이점이 있다.

### 사용시 주의할 점

PUT은 리소스를 **완전히 대체**한다. 만약 해당 데이터를 보내야 하는데

```json
{
  "username": "jelly",
  "age": 20
}
```

`age` 만 보낼경우 완전히 대체되기 때문에, 주의해야 한다.

```json
{
  "age": 20
}
```

이렇게 되면 리소스를 수정하기 어려운데, 사실 `PUT` 메서드는 리소스를 수정하기보다 통째로 갈아치우고 교체할때 주로 사용된다.

→ 그리고 보통 서버단에서 입력필드를 검사하고 모든 입력필드가 들어있지 않을 경우 에러를 띄우기 때문에, 양쪽에서 검증하는게 좋다.

---

### PATCH

리소스를 **부분 변경** 할때 사용하는 메서드로, `PUT` 예제처럼 일부 데이터만 보내면 해당하는 데이터만 업데이트된다.

- 서버에서 PATCH가 지원되지 않는 경우가 있는데, 이런 경우에도 `POST` 를 써서 처리할수 있다.

---

### DELETE

리소스를 **제거** 할때 사용되는 메서드이다.

---

## HTTP 메서드의 속성

### 안전(Safe Methods)

안전이라는 뜻은 호출해도 리소스를 변경하지 않는다는 의미이다.

만약 계속 `GET` 요청을 보낸다면 조회만 하는것이기 때문에 안전할 것이다. 하지만 계속 요청을 해서 서버에 장애가 생기거나 한다면? 서버는 해당 리소스가 안전한지만 고려하기 때문에 이러한 외부 상황들까지 고려하지는 않는다.

---

### 멱등(Idempotent Methods)

한 번 호출하든, 두 번 호출하든 100번 호출하든 응답 결과가 똑같은 것을 의미한다.

멱등 메서드는 다음과 같다.

- GET : 한 번 조회하든, 두 번 조회하든 같은 결과가 조회된다.
- PUT : 결과를 대체한다. 따라서 같은 요청을 여러번 해도 최종 결과는 같다.
- DELETE : 결과를 삭제한다. 같은 요청을 여러번 해도 삭제된 결과는 똑같다.

**`POST` 는 멱등이 아니다. 두번 호출하면 같은 결제가 중복해서 발생할 수 있다.**

### 멱등은 언제 활용할까?

자동 복구 메커니즘에 활용되는데, 만약 `DELETE` 요청을 보냈는데 서버에서 TIMEOUT 등으로 응답이 없을 경우 클라이언트가 같은 요청을 다시 보내도 되는가? 의 판단 근거로 활용된다.

→ DELETE는 여러번 요청을 보내도 멱등성을 가지기 때문에, 정상적 응답을 받지 못하였을 경우 같은 요청을 보내도 된다고 판단할수 있는것.

### 재요청 중간에 리소스를 다른 곳에서 변경해버리면?

만약 재요청을 하려는데 `PUT` 메서드로 다른 유저가 데이터를 바꿔버린다면 어떻게 될까?
→ 멱등은 **외부 요인** 까지는 고려하지 않는다. 해당 메서드로 내가 여러번 요청했을때 같은 응답을 보내느냐로만 판단하기 때문이다. 다른 유저가 변경하는 것은 외부요인이므로 고려되지 않는다.

---

### 캐시가능(Cacheable Methods)

만약 용량이 매우 큰 이미지를 매번 요청한다면 매우 비효율적일 것이다. 그래서 캐시 가능하다는것은 아주 중요한데, 캐시가능성을 판단하는 기준은 다음과 같다.

- 응답 결과 리소스를 캐시해서 사용해도 되는가?

실제로 캐시 가능한 메서드는 `GET` , `HEAD` , `POST` , `PATCH` 가 가능하지만,

캐시를 하려면 캐시 `key` 가 필요한데 `GET` 이나 `HEAD` 같은 경우 데이터를 조회만 하는 것이므로 `URL` 을 캐시키로 사용할수 있는 반면 POST나 PATCH의 경우는 body가 존재하기 때문에 캐시 구현이 쉽지 않다. 그래서 실무에서는 거의 GET만 캐시가 사용된다고 생각하면 된다.
